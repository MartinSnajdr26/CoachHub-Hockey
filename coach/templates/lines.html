{% extends "base.html" %}
{% block title %}Rozdƒõlen√≠ do lajn{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='lines.css', v=csp_nonce) }}">
<div class="lines-head">
  <h1>Rozdƒõlen√≠ hr√°ƒç≈Ø do formac√≠</h1>
  <button type="button" class="help-btn" data-help="lines" data-help-src="help-lines"><span class="ico">i</span> N√°povƒõda</button>
</div>
<div id="help-lines">
  <h3>Jak pou≈æ√≠vat Formace</h3>
  <ul>
    <li>P≈ôet√°hni hr√°ƒçe z poolu do slotu (LW/C/RW, LD/RD), nebo ≈•ukni na pilulku a pak na slot.</li>
    <li>Barvy karty nastav ‚ÄúPodklad‚Äù/‚ÄúText‚Äù; ukl√°daj√≠ se automaticky (per karta).</li>
    <li>Na mobilu swipuj mezi kartami; pager teƒçky ukazuj√≠ pozici.</li>
    <li>Tlaƒç√≠tko ‚ÄúVymazat v≈°echny v√Ωbƒõry‚Äù vypr√°zdn√≠ v≈°echny sloty.</li>
  </ul>
</div>

<div class="lines-container">
    <!-- LEV√ù sloupec ‚Äì drag & drop sestava -->
    <div class="lines-form">
        {# Macros to render slots #}
        {% macro slot_row(slot_name, accept, label) -%}
          <div class="slot accept-{{ accept }}" data-slot="{{ slot_name }}" data-accept="{{ accept }}" data-label="{{ label }}" aria-label="Slot {{ label }} {{ slot_name }}">
            <input type="hidden" name="{{ slot_name }}" value="{{ assignments.get(slot_name,'') }}">
            {% set pid = assignments.get(slot_name) %}
            {% if pid %}
              <div class="fill" data-id="{{ pid }}"><span>{{ (roster|selectattr('player_id','equalto',pid)|map(attribute='player.name')|first) }}</span><button type="button" class="btn-x" aria-label="Odstranit">√ó</button></div>
            {% else %}
              <span class="ph">P≈ôet√°hni {{ '√∫toƒçn√≠ka' if accept=='F' else ('obr√°nce' if accept=='D' else 'brank√°≈ôe') }}‚Ä¶</span>
            {% endif %}
          </div>
        {%- endmacro %}

        {# Render one formation card (used for grid and mobile swiper) #}
        {% macro formation_card(line) -%}
          <div class="formation" data-line="{{ line }}">
            <h3>{{ line }}. Formace</h3>
            <div class="lines-colorpick">
              <label>Podklad <input type="color" value="{{ brand.secondary or '#000000' }}" data-bg class="lines-color"></label>
              <label>Text <input type="color" value="{{ brand.primary or '#d4c76f' }}" data-fg class="lines-color"></label>
            </div>
            <div class="slots">
              {{ slot_row('L' ~ line ~ 'LW', 'F', 'LW') }}
              {{ slot_row('L' ~ line ~ 'C',  'F', 'C') }}
              {{ slot_row('L' ~ line ~ 'RW', 'F', 'RW') }}
            </div>
            <div class="slots slots--def">
              {{ slot_row('D' ~ line ~ 'LD', 'D', 'LD') }}
              {{ slot_row('D' ~ line ~ 'RD', 'D', 'RD') }}
            </div>
          </div>
        {%- endmacro %}
        <form method="POST" id="linesForm">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

            {# Pools: F, D, G (show all; assigned will be color-badged) #}
            <div class="lines-controls">
              <label class="lines-ctrl-label">
                <input type="checkbox" id="hideAssigned" checked> Skr√Ωt obsazen√© hr√°ƒçe
              </label>
              <button type="button" id="btnResetColors" class="btn-reset-colors">Vynulovat barvy formac√≠</button>
            </div>
            {% set assigned_ids = assignments.values()|list %}
            <div class="pool-title">√ötoƒçn√≠ci</div>
            <div class="pool" id="poolF">
              {% for r in roster if r.player.position == 'F' %}
                {% set ass_slot = '' %}
                {% for k,v in assignments.items() %}
                  {% if v == r.player.id %}{% set ass_slot = k %}{% endif %}
                {% endfor %}
                <div class="pl-item" draggable="true" data-id="{{ r.player.id }}" data-pos="F" data-ass-slot="{{ ass_slot }}">
                  <span class="pl-badge" data-badge>‚Äî</span> {{ r.player.name }}
                </div>
              {% endfor %}
            </div>
            <div class="pool-title">Obr√°nci</div>
            <div class="pool" id="poolD">
              {% for r in roster if r.player.position == 'D' %}
                {% set ass_slot = '' %}
                {% for k,v in assignments.items() %}
                  {% if v == r.player.id %}{% set ass_slot = k %}{% endif %}
                {% endfor %}
                <div class="pl-item" draggable="true" data-id="{{ r.player.id }}" data-pos="D" data-ass-slot="{{ ass_slot }}">
                  <span class="pl-badge" data-badge>‚Äî</span> {{ r.player.name }}
                </div>
              {% endfor %}
            </div>
            <div class="pool-title">Brank√°≈ôi</div>
            <div class="pool" id="poolG">
              {% for r in roster if r.player.position == 'G' %}
                {% set ass_slot = '' %}
                {% for k,v in assignments.items() %}
                  {% if v == r.player.id %}{% set ass_slot = k %}{% endif %}
                {% endfor %}
                <div class="pl-item" draggable="true" data-id="{{ r.player.id }}" data-pos="G" data-ass-slot="{{ ass_slot }}">
                  <span class="pl-badge" data-badge>‚Äî</span> {{ r.player.name }}
                </div>
              {% endfor %}
            </div>

            <div class="formations-grid desktop-only" id="formations">
            {% for line in range(1,5) %}
              {{ formation_card(line) }}
            {% endfor %}
            </div>

            <h2 class="desktop-only">Brank√°≈ôi</h2>
            <div class="slots desktop-only slots--g">
              <div class="slot accept-G" data-slot="G1" data-accept="G" data-label="G1">
                <input type="hidden" name="G1" value="{{ assignments.get('G1','') }}">
                {% set pid = assignments.get('G1') %}
                {% if pid %}
                  <div class="fill" data-id="{{ pid }}"><span>{{ (roster|selectattr('player_id','equalto',pid)|map(attribute='player.name')|first) }}</span><button type="button" class="btn-x" aria-label="Odstranit">√ó</button></div>
                {% else %}
                  <span class="ph">P≈ôet√°hni brank√°≈ôe‚Ä¶</span>
                {% endif %}
              </div>
              <div class="slot accept-G" data-slot="G2" data-accept="G" data-label="G2">
                <input type="hidden" name="G2" value="{{ assignments.get('G2','') }}">
                {% set pid = assignments.get('G2') %}
                {% if pid %}
                  <div class="fill" data-id="{{ pid }}"><span>{{ (roster|selectattr('player_id','equalto',pid)|map(attribute='player.name')|first) }}</span><button type="button" class="btn-x" aria-label="Odstranit">√ó</button></div>
                {% else %}
                  <span class="ph">P≈ôet√°hni brank√°≈ôe‚Ä¶</span>
                {% endif %}
              </div>
            </div>

            {# Mobile swiper: horizontal slides (1 card per view) #}
            <div class="lines-swiper" aria-label="P≈ôejeƒè pro dal≈°√≠ formace">
              <div class="lines-track" id="linesTrack">
                {% for line in range(1,5) %}
                  <div class="slide">
                    {{ formation_card(line) }}
                  </div>
                {% endfor %}
                <div class="slide">
                  <div class="formation" data-line="G">
                    <h3>Brank√°≈ôi</h3>
                    <div class="slots slots--def">
                      {{ slot_row('G1','G','G1') }}
                      {{ slot_row('G2','G','G2') }}
                    </div>
                  </div>
                </div>
              </div>
              <div class="lines-pager" id="linesPager" aria-label="Str√°nkov√°n√≠ formac√≠"></div>
            </div>
            <div class="actions">
              <button type="submit">üíæ Ulo≈æit Formace</button>
              <button type="button" class="btn-lines-clear">üßπ Vymazat v≈°echny v√Ωbƒõry</button>
            </div>
        </form>

        {# script moved to scripts block to load late #}
    </div>

    {% if is_coach %}
    <div class="lines-export">
      <hr>
      <h2>Export sestavy do PDF</h2>
      <form method="post" action="{{ url_for('export_lines_pdf') }}" class="lines-export-form">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <label>Soupe≈ô<br>
              <input type="text" name="opponent" placeholder="Soupe≈ô" class="lines-input">
          </label>
          <label>Datum<br>
              <input type="date" name="date" value="{{ (namespace().today if false else '') }}" class="lines-input">
          </label>
          <button type="submit">üìÑ Exportovat PDF a ulo≈æit</button>
          <a href="{{ url_for('lineup_sessions') }}"><button type="button">üóÇ Seznam sestav</button></a>
      </form>
    </div>
    {% endif %}
</div>

{# moved to static/app.js #}
{% endblock %}
{% block scripts %}
  {{ super() }}
  <script src="{{ url_for('static', filename='lines.js', v=csp_nonce) }}" nonce="{{ csp_nonce }}" defer></script>
  <script nonce="{{ csp_nonce }}">
    // Sentinel: if external JS didn't set __linesBound shortly after load, surface a small hint
    setTimeout(function(){
      try {
        if(!window.__linesBound){
          console.error('[lines] init sentinel: external JS did not run');
          var note=document.createElement('div');
          note.textContent='Lines: skript se nespustil (zkontroluj konzoli/CSP)';
          note.style.cssText='position:fixed;bottom:10px;left:10px;background:#c44747;color:#fff;padding:6px 10px;border-radius:6px;z-index:9999;font:14px/1.2 system-ui';
          document.body.appendChild(note);
          setTimeout(function(){ if(note && note.parentNode) note.parentNode.removeChild(note); }, 4000);
        } else {
          console.debug('[lines] init sentinel ok', window.__linesBound);
        }
      } catch(e){}
    }, 100);
  </script>
{% endblock %}
