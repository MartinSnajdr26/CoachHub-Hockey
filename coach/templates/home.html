{% extends "base.html" %}
{% block title %} Domů{% endblock %}

{% block content %}

<div class="home-wrap">
  <div class="home-cards-col">
    <div class="cards-holder" style="text-align:left; width:100%;">
      
      <div class="cards cards-home">
          <div class="card">
              <h2>👥 Hráči</h2>
              <p>Správa kádru, přidávání a mazání hráčů.</p>
              <a href="/players"><button>Otevřít</button></a>
          </div>
          <div class="card">
              <h2>📋 Soupiska</h2>
              <p>Vyber nominaci na zápas a připrav soupisku.</p>
              <a href="/roster"><button>Otevřít</button></a>
          </div>
          <div class="card">
              <h2>🏒 Formace</h2>
              <p>Rozděl hráče do lajn a sestav útoky i obrany.</p>
              <a href="/lines"><button>Otevřít</button></a>
          </div>
          <div class="card">
              <h2>📝 Tréninky</h2>
              <p>Vytvářej a ukládej cvičení, plánuj tréninky.</p>
              <a href="/drills"><button>Otevřít</button></a>
          </div>
      </div>

      <!-- Message board moved under cards -->
      <div class="card message-card" style="margin-top:16px; text-align:left;">
        <h2 style="margin-top:0;">📣 Nástěnka týmu</h2>
        <p style="margin-top:-6px; opacity:0.8;">Posledních 50 zpráv</p>
        <form class="mb-form" method="post" action="{{ url_for('calendar.message_post') }}">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <textarea name="text" rows="2" maxlength="500" placeholder="Napiš zprávu pro tým… (max 500 znaků)"></textarea>
          <button type="submit">➤ Odeslat</button>
        </form>
        <div class="mb-list">
          {% for msg in team_messages %}
            <div class="mb-item">
              <div class="mb-meta">
                <span>
                  {% if msg.pinned %}📌 {% endif %}
                  {{ msg.created_at.strftime('%Y-%m-%d %H:%M') }} • {{ 'Trenér' if (msg.role=='coach') else 'Hráč' }}
                </span>
                {% if (is_coach_home|default(is_coach)) %}
                  <span class="mb-actions">
                    <form method="post" action="{{ url_for('calendar.message_pin', msg_id=msg.id) }}">
                      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                      <button type="submit" title="Připnout / odepnout">📌</button>
                    </form>
                    <form method="post" action="{{ url_for('calendar.message_delete', msg_id=msg.id) }}" onsubmit="return confirm('Smazat zprávu?');">
                      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                      <button type="submit" title="Smazat">🗑</button>
                    </form>
                  </span>
                {% endif %}
              </div>
              <div class="mb-text">{{ msg.text }}</div>
            </div>
          {% else %}
            <div style="opacity:0.7;">Zatím žádné zprávy.</div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>

  <div class="calendar-col">
    <h2 class="month-title" style="margin:0 0 8px;">{{ month_title }}</h2>
    <p style="margin:0 4px 6px; display:flex; align-items:center; gap:8px; flex-wrap:wrap; border:2px solid var(--brand-secondary, #000); border-radius:8px; padding:6px 8px; background:#fff; color: var(--brand-secondary, #000);">
      <a href="{{ url_for('home', year=prev_year, month=prev_month) }}"><button>◀ Předchozí</button></a>
      <a href="{{ url_for('home') }}"><button>Dnes</button></a>
      <a href="{{ url_for('home', year=next_year, month=next_month) }}"><button>Další ▶</button></a>
      <span style="margin-left:12px; opacity:0.8;">Dnes: {{ today_label }}</span>
    </p>
    <p class="calendar-hint">Klepnutím na den zobrazíš detail.</p>
    <p class="calendar-legend" style="margin:0 0 10px; display:flex; align-items:center; gap:14px;">
      <span style="display:inline-flex; align-items:center; gap:6px;">
        <span style="display:inline-block; width:8px; height:6px; background: var(--brand-primary, #d4c76f); border:2px solid var(--brand-secondary, #000); border-radius:2px;"></span>
        Trénink
      </span>
      <span style="display:inline-flex; align-items:center; gap:6px;">
        <span style="display:inline-block; width:8px; height:6px; background: var(--brand-secondary, #000); border:2px solid var(--brand-primary, #d4c76f); border-radius:2px;"></span>
        Zápas
      </span>
    </p>
    <div class="calendar-wrap table-scroll" data-is-coach="{{ '1' if (is_coach_home|default(is_coach)) else '0' }}">
    <table style="width:100%; border-collapse:collapse;">
      <thead>
        <tr>
          {% for wd in ['Po','Út','St','Čt','Pá','So','Ne'] %}
            <th>{{ wd }}</th>
          {% endfor %}
        </tr>
      </thead>
      <tbody>
        {% for week in weeks %}
          <tr>
            {% for day in week %}
              {% set in_month = (day.month == cal_month) %}
              {% set is_today = (day.isoformat() == today_iso) %}
              {% set key = day.isoformat() %}
              {% set evs = events_by_day.get(key, []) %}
              {% set ns = namespace(has_match=false, has_training=false, first_title='', first_time='') %}
              {% for ev in evs %}
                {% set kind = (ev.kind or 'training') %}
                {% if kind == 'match' %}{% set ns.has_match = true %}{% endif %}
                {% if kind == 'training' %}{% set ns.has_training = true %}{% endif %}
                {% if not ns.first_title %}{% set ns.first_title = ev.title %}{% set ns.first_time = ev.time or '' %}{% endif %}
              {% endfor %}
              <td class="cal-cell {{ 'in-month' if in_month else 'out-month' }} {{ 'is-today' if is_today else '' }} {{ 'has-match' if ns.has_match else ('has-training' if ns.has_training else '') }}"
                  data-kind="{{ 'match' if ns.has_match else ('training' if ns.has_training else '') }}"
                  data-title="{{ ns.first_title }}" data-time="{{ ns.first_time }}">
                <div class="cal-cell-head" style="display:flex; justify-content:space-between; align-items:center;">
                  {% if is_today %}
                    <strong style="color: var(--tertiary, #c44747); font-weight:800;">{{ day.day }}</strong>
                  {% else %}
                    <strong>{{ day.day }}</strong>
                  {% endif %}
                  {% if ns.has_match or ns.has_training %}
                    <span class="day-badge" aria-hidden="true">{{ 'Z' if ns.has_match else 'T' }}</span>
                  {% endif %}
                  {% if in_month and (is_coach_home|default(is_coach)) %}
                    <details>
                      <summary style="cursor:pointer; font-size:12px; line-height:1;">➕</summary>
                      <form method="POST" action="{{ url_for('calendar_add') }}" style="display:flex; flex-direction:column; gap:6px; margin-top:6px;">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <input type="hidden" name="day" value="{{ day.isoformat() }}">
                        <label style="font-size:12px;">
                          Čas (24h)
                          <span style="display:inline-flex; gap:4px; align-items:center;">
                            <select name="time_hour" style="padding:4px 6px; border:1px solid #bbb; border-radius:6px;">
                              {% for h in range(0,24) %}
                                {% set h2 = '%02d' % h %}
                                <option value="{{ h2 }}" {% if h==18 %}selected{% endif %}>{{ h2 }}</option>
                              {% endfor %}
                            </select>
                            :
                            <select name="time_minute" style="padding:4px 6px; border:1px solid #bbb; border-radius:6px;">
                              {% for minute in range(0,60) %}
                                {% set min2 = '%02d' % minute %}
                                <option value="{{ min2 }}" {% if minute==0 %}selected{% endif %}>{{ min2 }}</option>
                              {% endfor %}
                            </select>
                          </span>
                        </label>
                        <input type="text" name="title" placeholder="Název (např. Trénink A)" style="padding:4px 6px; border:1px solid #bbb; border-radius:6px;">
                        <label style="font-size:12px;">Typ
                          <select name="kind">
                            <option value="training" selected>Trénink</option>
                            <option value="match">Zápas</option>
                          </select>
                        </label>
                        <button type="submit">Přidat</button>
                      </form>
                    </details>
                  {% endif %}
                </div>
                {% for ev in evs %}
                  {% set c = 'var(--brand-primary, #d4c76f)' if (ev.kind or 'training') == 'training' else 'var(--brand-secondary, #000)' %}
                  <div class="cal-event" style="border-left:3px solid {{ c }};">
                    <b>{{ ev.time or '' }}</b> {{ ev.title }}
                    {% if (is_coach_home|default(is_coach)) %}
                      <details>
                        <summary style="cursor:pointer; font-size:12px; opacity:0.8;">Upravit</summary>
                        <form method="POST" action="{{ url_for('calendar_update') }}" style="display:flex; gap:6px; align-items:center; flex-wrap:wrap; margin-top:6px;">
                          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                          <input type="hidden" name="id" value="{{ ev.id }}">
                          <label style="font-size:12px;">
                            Čas (24h)
                            {% set th = (ev.time or '00:00')[:2] %}
                            {% set tm = (ev.time or '00:00')[3:5] %}
                            <span style="display:inline-flex; gap:4px; align-items:center;">
                              <select name="time_hour" style="padding:4px 6px; border:1px solid #bbb; border-radius:6px;">
                                {% for h in range(0,24) %}
                                  {% set h2 = '%02d' % h %}
                                  <option value="{{ h2 }}" {% if h2==th %}selected{% endif %}>{{ h2 }}</option>
                                {% endfor %}
                              </select>
                              :
                              <select name="time_minute" style="padding:4px 6px; border:1px solid #bbb; border-radius:6px;">
                                {% for minute in range(0,60) %}
                                  {% set min2 = '%02d' % minute %}
                                  <option value="{{ min2 }}" {% if min2==tm %}selected{% endif %}>{{ min2 }}</option>
                                {% endfor %}
                              </select>
                            </span>
                          </label>
                          <input type="text" name="title" value="{{ ev.title }}" style="padding:4px 6px; border:1px solid #bbb; border-radius:6px;">
                          <select name="kind">
                            <option value="training" {% if (ev.kind or 'training')=='training' %}selected{% endif %}>Trénink</option>
                            <option value="match" {% if (ev.kind or 'training')=='match' %}selected{% endif %}>Zápas</option>
                          </select>
                          <button type="submit">Uložit</button>
                        </form>
                        <form method="POST" action="{{ url_for('calendar_delete') }}" class="form-confirm" data-message="Smazat událost?" style="margin-top:6px;">
                          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                          <input type="hidden" name="id" value="{{ ev.id }}">
                          <button type="submit" style="background: var(--tertiary, #c44747); color:#fff;">🗑 Smazat</button>
                        </form>
                      </details>
                    {% endif %}
                  </div>
                {% endfor %}
              </td>
            {% endfor %}
          </tr>
        {% endfor %}
      </tbody>
    </table>
    </div>

    {# Mobilní panel pro přidání/úpravu události přes celou šířku kalendáře #}
    <div id="calFormSheet" class="cal-form-sheet" aria-hidden="true">
      <div class="cal-form-sheet__inner">
        <div class="cal-form-sheet__header">
          <strong>Přidat / upravit událost</strong>
          <button type="button" class="cal-form-sheet__close" aria-label="Zavřít">✖</button>
        </div>
        <div class="cal-form-sheet__content"></div>
      </div>
    </div>
  </div>
</div>

{% endblock %}
