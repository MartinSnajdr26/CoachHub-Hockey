{% extends "base.html" %}
{% block title %}Trénink: {{ sess.title }}{% endblock %}

{% block content %}
<h1>Tréninková jednotka</h1>
<p><b>Název:</b> {{ sess.title }}</p>
<p><b>Vytvořeno:</b> {{ sess.created_at.strftime('%Y-%m-%d %H:%M') }}</p>

<p style="margin:10px 0; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
  <a href="{{ url_for('drill_sessions') }}">← Zpět na seznam tréninků</a>
  {% set abs_page = url_for('drills.drill_session_detail', sess_id=sess.id, _external=True) %}
  <a href="https://api.whatsapp.com/send?text={{ ('Tréninková jednotka: ' ~ sess.title ~ ' ' ~ abs_page) | urlencode }}" target="_blank"><button>📲 Sdílet odkaz</button></a>
  {% if sess.filename and sess.filename != '-' %}
    <a href="{{ url_for('download_export', filename=sess.filename) }}" target="_blank"><button>📄 Otevřít PDF</button></a>
  {% endif %}
  <span style="font-size:12px; opacity:0.8;">Sdílejte tento odkaz s hráči – uvidí seznam cvičení a v detailu spustí animaci.</span>
  {% if is_coach %}
    <form method="post" action="{{ url_for('drills.delete_drill_session', sess_id=sess.id) }}" onsubmit="return confirm('Smazat tuto tréninkovou jednotku? {{ 'PDF bude odstraněno.' if sess.filename and sess.filename != '-' else '' }}');" style="margin-left:auto;">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <button type="submit" style="background:#b33; color:#fff;">🗑 Smazat jednotku</button>
    </form>
  {% endif %}
  
  
</p>

<div class="cards">
  {% for d in drills %}
    <div class="card">
      <h2>{{ d.name }}</h2>
      <p><b>Kategorie:</b> {{ d.category or '-' }} | <b>Čas:</b> {{ d.duration or 0 }} min</p>
      <p>
        <a href="{{ url_for('drill_detail', drill_id=d.id) }}"><button>👁 Otevřít detail</button></a>
        <button type="button" class="btn-quick-play" data-drill-id="{{ d.id }}">▶️ Rychlé přehrání</button>
      </p>
      {% if d.image_data %}
        <img src="{{ d.image_data }}" style="max-width:100%; border:2px solid var(--brand-primary, #d4c76f); border-radius:8px; margin:10px 0;">
      {% else %}
        <p><i>Bez náhledu</i></p>
      {% endif %}
    </div>
  {% else %}
    <p><i>Tento trénink nemá přiřazená žádná cvičení.</i></p>
  {% endfor %}
  
</div>

<!-- Quick Play Overlay -->
<div id="qpOverlay" style="display:none; position:fixed; inset:0; background: rgba(0,0,0,0.6); z-index: 2300; align-items:center; justify-content:center;">
  <div style="background:#fff; color:#000; border-radius:10px; border:2px solid #000; box-shadow:0 10px 30px rgba(0,0,0,0.35); width:min(96vw, 1100px); height:min(90vh, 800px); display:flex; flex-direction:column;">
    <div style="display:flex; align-items:center; justify-content:space-between; gap:8px; padding:8px 10px; border-bottom:1px solid #ccc;">
      <strong>Rychlé přehrání</strong>
      <button type="button" id="qpClose" style="background:#000; color:#fff; border:none; padding:4px 8px; border-radius:6px; font-weight:700;">✖ Zavřít</button>
    </div>
    <div style="flex:1; min-height:0;">
      <iframe id="qpFrame" src="about:blank" style="width:100%; height:100%; border:0; background:#fff;" allow="fullscreen"></iframe>
    </div>
  </div>
  
</div>

<script nonce="{{ csp_nonce }}">
  document.addEventListener('DOMContentLoaded', function(){
    var overlay = document.getElementById('qpOverlay');
    var frame = document.getElementById('qpFrame');
    var btnClose = document.getElementById('qpClose');
    function openQP(drillId){
      if(!overlay || !frame) return;
      try { frame.src = '{{ url_for('drill_detail', drill_id=0) }}'.replace('/0', '/' + drillId) + '?autoplay=1&embed=1'; } catch(_){ frame.src = '/drill/' + drillId + '?autoplay=1&embed=1'; }
      overlay.style.display = 'flex';
      // outside click closes
      setTimeout(function(){ document.addEventListener('click', outsideHandler, true); }, 30);
    }
    function closeQP(){ if(overlay){ overlay.style.display='none'; } if(frame){ frame.src='about:blank'; } try { document.removeEventListener('click', outsideHandler, true); } catch(_){ } }
    function outsideHandler(ev){ try { if(!overlay.contains(ev.target)){ closeQP(); } } catch(_){ }
    }
    document.querySelectorAll('.btn-quick-play').forEach(function(btn){ btn.addEventListener('click', function(){ var id = btn.getAttribute('data-drill-id'); openQP(id); }); });
    if(btnClose){ btnClose.addEventListener('click', closeQP); }
  });
</script>

{% endblock %}
